name: Build iOS IPA & Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-15
    env:
      scheme_name: Ksign
      proj_path: Ksign.xcodeproj
      archive_path: ${{ github.workspace }}/build/Ksign.xcarchive
      export_path: ${{ github.workspace }}/output
      ipa_name: Ksign.ipa

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set Xcode 16
      run: sudo xcode-select -s "/Applications/Xcode_16.app"

    - name: Create folders
      run: mkdir -p build output

    - name: Create ExportOptions.plist
      run: |
        cat <<EOF > ExportOptions.plist
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
        "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>provisioningProfiles</key>
            <dict/>
        </dict>
        </plist>
        EOF

    - name: Archive
      run: |
        xcodebuild \
          -project "${proj_path}" \
          -scheme "${scheme_name}" \
          -configuration Release \
          -sdk iphoneos \
          -archivePath "${archive_path}" \
          -skipPackagePluginValidation \
          clean archive \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          DEVELOPMENT_TEAM="" \
          ONLY_ACTIVE_ARCH=NO | xcpretty

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath "${archive_path}" \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath "${export_path}"
        mv "${export_path}"/*.ipa "${export_path}/${ipa_name}" || echo "No IPA found"

    - name: Create Tag
      id: tag
      run: |
        TAG="build-$(date +'%Y%m%d-%H%M%S')"
        git tag $TAG
        git push origin $TAG
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        files: ${{ env.export_path }}/${{ env.ipa_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
